stages:
  - security
  - build
  - tests
  - publish
  - release

.reports: &reports
  name: reports
  when: always
  paths: ["**/build/reports"]
  reports:
    junit: "**/build/test-results/**/TEST-*.xml"

.cache-linux: &cache-linux
  - key: krypton-core-cache-linux
    policy: pull-push
    paths:
      - $CI_PROJECT_DIR/.konan
      - $CI_PROJECT_DIR/.gradle

.cache-macos: &cache-macos
  - key: krypton-core-cache-macos
    policy: pull-push
    paths:
      - $CI_PROJECT_DIR/.konan
      - $CI_PROJECT_DIR/.gradle

.if-main: &if-main
  - if: $CI_PIPELINE_SOURCE == "schedule"
    when: never
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

trivy:
  stage: security
  tags: ["linux", "x86_64"]
  artifacts:
    when: always
    reports:
      dependency_scanning: .dependency-report.json
  script:
    - ./gradlew krypton:dependencies --write-locks
    - trivy fs --security-checks vuln --severity HIGH,CRITICAL --exit-code 1 --format template --template "@/contrib/gitlab.tpl" --output .dependency-report.json .

build:linux:
  stage: build
  tags: ["linux", "x86_64"]
  needs: ["trivy"]
  image: java:21-jdk
  cache:
    - *cache-linux
  script:
    - ./gradlew compileKotlin{Jvm,LinuxX64,MingwX64} linkDebugTest{LinuxX64,MingwX64} --stacktrace

build:macos:
  stage: build
  tags: ["macos", "arm64"]
  needs: ["trivy"]
  image: java:21-jdk
  cache:
    - *cache-macos
  script:
    - ./gradlew compileKotlin{MacosX64,MacosArm64,IosSimulatorArm64,IosArm64,IosX64} linkDebugTest{MacosArm64,IosSimulatorArm64,IosX64} --stacktrace

tests:linux:
  stage: tests
  needs: ["build:linux"]
  tags: ["linux", "x86_64"]
  image: java:21-jdk
  artifacts: *reports
  cache:
    - *cache-linux
  script:
    - ./gradlew {jvm,linuxX64}Test --stacktrace

tests:macos:
  stage: tests
  needs: ["build:macos"]
  tags: ["macos", "arm64"]
  image: java:21-jdk
  artifacts: *reports
  cache:
    - *cache-macos
  script:
    - ./gradlew {macosArm64,iosSimulatorArm64,iosX64}Test --stacktrace

publish:linux:
  stage: publish
  needs: ["tests:linux"]
  tags: ["linux", "x86_64"]
  cache:
    - *cache-linux
  rules:
    - *if-main
  script:
    - ./gradlew dokkaHtml publish{KotlinMultiplatform,Jvm,LinuxX64,MingwX64}PublicationToKarmaKraftsRepository --stacktrace

publish:macos:
  stage: publish
  needs: ["tests:macos"]
  tags: ["macos", "x86_64"]
  cache:
    - *cache-macos
  rules:
    - *if-main
  script:
    - ./gradlew dokkaHtml publish{MacosArm64,MacosX64,IosArm64,IosSimulatorArm64,IosX64}PublicationToKarmaKraftsRepository --stacktrace

create-release:
  stage: release
  needs: ["publish:linux", "publish:macos"]
  rules:
    - *if-main
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: '${cat .version}.$CI_PIPELINE_IID'
    description: '${cat .version}.$CI_PIPELINE_IID'
    ref: '$CI_COMMIT_SHA'
  tags:
    - linux
